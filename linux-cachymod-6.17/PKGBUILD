# PKGBUILD originated from CachyOS, modified for CachyMod.
# https://github.com/marioroy/cachymod
# https://wiki.archlinux.org/title/PKGBUILD

### BUILD OPTIONS
# Set these variables to ANYTHING that is not null or choose proper variable to enable them

# Select CPU scheduler { eevdf, bore, rt, bmq }
# eevdf: EEVDF Scheduler (use with the linux-cgroup-always repo, optional)
# bore:  EEVDF Scheduler with Burst-Oriented Response Enhancer
# rt:    EEVDF Scheduler with real-time preemption enabled
# bmq:   BitMap Queue Scheduler
: "${_cpusched:=eevdf}"

# Custom kernel suffix, specify uniquely if building multiple CachyMod kernels
# E.g. { blank value, bmq, bore, rt } or { 617, 617-bmq, 617-bore, 617-rt }
# Or set to "auto" for automatic suffix { gcc, clang, lto }
# Or set to blank value for no kernel suffix
: "${_kernel_suffix:=}"

# Prevent AVX2 floating-point instructions. (Clear and XanMod default)
: "${_prevent_avx2:=yes}"

# Run the "trim.sh" script to trim the kernel
# Deselects ~ 1,500 kernel options
: "${_runtrim_script:=yes}"

# Tweak kernel options prior to a build via nconfig, gconfig or xconfig
: "${_makenconfig:=no}"
: "${_makegconfig:=no}"
: "${_makexconfig:=no}"

# Transparent Hugepages
# ATTENTION: one of two predefined values should be selected!
# 'always'  - always enable THP
# 'madvise' - madvise, prevent applications from allocating more memory resources than necessary
# More infos here:
# https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/performance_tuning_guide/sect-red_hat_enterprise_linux-performance_tuning_guide-configuring_transparent_huge_pages
: "${_hugepage:=always}"

# Compile ONLY used modules to VASTLY reduce the number of modules built
# and the build time.
#
# To keep track of which modules are needed for your specific system/hardware,
# give module_db script a try: https://aur.archlinux.org/packages/modprobed-db
# This PKGBUILD read the database kept if it exists
#
# More at this wiki page ---> https://wiki.archlinux.org/index.php/Modprobed-db
: "${_localmodcfg:=no}"

# Path to the list of used modules
: "${_localmodcfg_path:=$HOME/.config/modprobed.db}"

# Include the modules in minimal-modprobed.db (use with _localmodcfg)
# This is the diet db from Linux-tkg
: "${_localmodcfg_minimal:=no}"

# Enable TCP_CONG_BBR3
: "${_tcp_bbr3:=no}"

# Running with a 1000HZ, 800Hz, 750Hz, 600Hz, or 500Hz tick rate
: "${_HZ_ticks:=1000}"

# Choose between full or idle tickless type
# Full tickless can give higher performances in various cases but, depending on
# hardware, lower consistency. Idle (without rcu_nocb_cpu) may reduce stutters.
: "${_ticktype:=full}"

# Select preemption { dynamic, voluntary, full, lazy }
# Select "dynamic" for runtime selectable none, voluntary, (full), or lazy.
# Select "voluntary" for desktop, matching the Clear kernel preemption.
# Select "full" for low-latency desktop, matching the CachyOS kernel preemption.
# Select "lazy" for low-latency desktop, for slightly better throughput.
: "${_preempt:=dynamic}"

# Select CPU compiler optimization
# { generic, generic_v1, generic_v2, generic_v3, generic_v4, native, zen4 }
: "${_processor_opt:=}"

# Select build type { thin, clang, gcc }
# thin:  Build the kernel with clang thin-LTO, auto suffix "-lto"
#        Uses multiple threads, faster and lesser memory consumption,
#        possibly lower runtime performance than full
# clang: Build kernel with clang, auto suffix "-clang"
# gcc:   Build kernel with gcc, auto suffix "-gcc"
: "${_buildtype:=thin}"

# Build a debug package with non-stripped vmlinux
: "${_build_debug:=no}"

# Enable AUTOFDO_CLANG for the first compilation,
#  to create a kernel, which can be used for profiling
# Workflow:
#  https://cachyos.org/blog/2411-kernel-autofdo/
#  https://docs.kernel.org/dev-tools/autofdo.html
# Steps:
# 1. Compile Kernel with _build_debug=yes and _autofdo=yes
# 2. Boot the kernel in QEMU or on your system, see Workload
# 3. Profile the kernel and convert the profile, see Generating...
# 4. Put the profile into the source dir
# 5. Build kernel again with _autofdo_profile_name specified
: "${_autofdo:=yes}"

# Name for the AutoFDO profile
: "${_autofdo_profile_name:=cachymod.afdo}"


# ATTENTION: Do not modify after this line

if [[ "$_buildtype" =~ ^(gcc|clang)$ ]]; then
    _autofdo="no"
    _autofdo_profile_name=""
fi

[ "$_buildtype" = "thin" ] \
    && buildtype="lto" || buildtype="$_buildtype"

if [ "$_kernel_suffix" = "auto" ]; then
    kernel_suffix="$buildtype"
elif [ -n "$_kernel_suffix" ]; then
    kernel_suffix="$_kernel_suffix"
else
    kernel_suffix=""
fi

_pkgsuffix=cachymod
_major=6.17
_minor=7
pkgver=${_major}.${_minor}
_stable=${_major}.${_minor}
#_stable=${_major}

_srcname=linux-${_stable}
pkgdesc='CachyMod Linux Kernel with other patches and improvements'
pkgrel=1
_kernver="$pkgver-$pkgrel"
_kernuname="${pkgver}-${_pkgsuffix}"
arch=('x86_64')
url="https://github.com/marioroy/cachymod"
license=('GPL-2.0-only')
options=('!strip' '!debug' '!lto')

makedepends=(bc cpio gettext libelf pahole perl python tar xz zstd)

source=(
  # "https://github.com/torvalds/linux/archive/refs/tags/v${_major}-${_rcver}.tar.gz"
    "https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/${_srcname}.tar.xz"
    "config"
    "config.sh"
    "trim.sh"
    "minimal-modprobed.db"
    "0001-rt.patch"
    "0002-bbr3.patch"
    "0003-block.patch"
    "0004-cachy.patch"
    "0005-fixes.patch"
    "0100-kconfig-add-800Hz.patch"
    "0110-fair-drm-scheduler.patch"
    "0140-rm-redundant-rculocks.patch"
    "0200-clearlinux-extras.patch"
    "0210-cachymod-misc.patch"
    "0250-sched-ext-updates.patch"
    "0260-fair-update-cachy-mods.patch"
    "0300-x86-prevent-avx2-vector.patch"
    "0310-linux6.17-bore.patch"
    "0310-linux6.17-prjc.patch"
)

# LLVM makedepends
if [[ "$buildtype" =~ (lto|clang) ]]; then
    makedepends+=(clang llvm lld)
    source+=("dkms-clang.patch" "flags-clang.patch" "thindist.patch")

    BUILD_FLAGS=(CC=clang LD=ld.lld LLVM_IAS=1)
    CLANG_BIN=$(which clang) ; CLANG_BIN="${CLANG_BIN%clang}"
    [ "$CLANG_BIN" = "/usr/bin/" ] && BUILD_FLAGS+=(LLVM=1)

    if [[ "$CLANG_BIN" != "/usr/bin/" && -x "${CLANG_BIN}/llvm-strip" ]]; then
        BUILD_FLAGS+=(LLVM="$CLANG_BIN")
    else
        BUILD_FLAGS+=(LLVM=1)
    fi
else
    BUILD_FLAGS=(CC=gcc)
fi

_die() { error "$@" ; exit 1; }

# Use generated AutoFDO Profile
if [[ "$_autofdo" =~ ^(yes|y|1)$ && -n "$_autofdo_profile_name" ]]; then
    if [ -e "$_autofdo_profile_name" ]; then
        source+=("$_autofdo_profile_name")
    else
        _die "Failed to find file ${_autofdo_profile_name}"
    fi
fi

# Append extra sources in build.sh
[ -n "$_extra_patch_or_url0" ] && source+=("$_extra_patch_or_url0")
[ -n "$_extra_patch_or_url1" ] && source+=("$_extra_patch_or_url1")
[ -n "$_extra_patch_or_url2" ] && source+=("$_extra_patch_or_url2")
[ -n "$_extra_patch_or_url3" ] && source+=("$_extra_patch_or_url3")
[ -n "$_extra_patch_or_url4" ] && source+=("$_extra_patch_or_url4")
[ -n "$_extra_patch_or_url5" ] && source+=("$_extra_patch_or_url5")
[ -n "$_extra_patch_or_url6" ] && source+=("$_extra_patch_or_url6")
[ -n "$_extra_patch_or_url7" ] && source+=("$_extra_patch_or_url7")
[ -n "$_extra_patch_or_url8" ] && source+=("$_extra_patch_or_url8")
[ -n "$_extra_patch_or_url9" ] && source+=("$_extra_patch_or_url9")

if [ -s "custom.sh" ]; then
    custom_script="$(pwd)/custom.sh"
else
    custom_script=""
fi

pkgbase="linux-$_pkgsuffix"
if [ -n "$kernel_suffix" ]; then
    pkgbase="${pkgbase}-${kernel_suffix}"
fi

export KBUILD_BUILD_HOST=cachyos
export KBUILD_BUILD_USER="$pkgbase"
export KBUILD_BUILD_TIMESTAMP="$(date -Ru${SOURCE_DATE_EPOCH:+d @$SOURCE_DATE_EPOCH})"

prepare() {
    cd "$_srcname"

    echo "Setting version..."
    echo "-$pkgrel" > localversion.10-pkgrel
    echo "${pkgbase#linux}" > localversion.20-pkgname

    local src
    for src in "${source[@]}"; do
        src="${src%%::*}"
        src="${src##*/}"
        src="${src%.zst}"
        [[ $src = *.patch ]] || continue
        if [[ $src = *-prevent-avx2* ]]; then
            [[ "$_prevent_avx2" =~ ^(yes|y|1)$ ]] || continue
        fi
        if [[ $src = *-bore* ]]; then
            [[ "$_cpusched" = "bore" ]] || continue
        fi
        if [[ $src = *-prjc* ]]; then
            [[ "$_cpusched" = "bmq" ]] || continue
        fi
        echo "Applying patch $src..."
        patch -Np1 < "../$src"
    done

    echo "Setting config..."
    cp ../config .config

    ### Remove RT version file
    rm -f localversion-rt

    ### Select CPU optimization (default Generic)
    if [ -n "$_processor_opt" ]; then
        MARCH="${_processor_opt^^}"
        if [ "$MARCH" != "GENERIC" ]; then
            if [[ "$MARCH" =~ GENERIC_V[1-4] ]]; then
                X86_64_LEVEL="${MARCH//GENERIC_V}"
                echo "Selecting CPU (X86_64_VERSION) : ${X86_64_LEVEL}"
                scripts/config --set-val X86_64_VERSION "${X86_64_LEVEL}"
            elif [ "$MARCH" = "NATIVE" ]; then
                echo "Selecting CPU (MARCH) : ${MARCH}"
                scripts/config -d GENERIC_CPU -e X86_NATIVE_CPU
            elif [ "$MARCH" = "ZEN4" ]; then
                echo "Selecting CPU (MARCH) : ${MARCH}"
                scripts/config -d GENERIC_CPU -e "M${MARCH}"
            fi
        fi
    else
        echo "Selecting CPU (MARCH) : NATIVE"
        scripts/config -d GENERIC_CPU -e X86_NATIVE_CPU
    fi

    ### Selecting CachyOS config
    echo "Enabling CachyOS config..."
    scripts/config -e CACHY

    ### Selecting the CPU scheduler
    case "$_cpusched" in
        eevdf|rt) ;;
        bore) scripts/config -e SCHED_BORE --set-val MIN_BASE_SLICE_NS 1600000;;
        bmq) scripts/config -e SCHED_ALT -e SCHED_BMQ;;
        *) _die "The _cpusched value '$_cpusched' is invalid. Choose the correct one again.";;
    esac

    echo "Selecting '${_cpusched^^}' CPU scheduler..."

    ### Select build type
    case "$_buildtype" in
        thin)
            scripts/config -e LTO -e LTO_CLANG -e ARCH_SUPPORTS_LTO_CLANG -e ARCH_SUPPORTS_LTO_CLANG_THIN -e HAS_LTO_CLANG -d LTO_NONE -d LTO_CLANG_FULL -d LTO_CLANG_THIN -e LTO_CLANG_THIN_DIST -e HAVE_GCC_PLUGINS
            ;;
        clang)
            scripts/config -e LTO -e LTO_CLANG -e ARCH_SUPPORTS_LTO_CLANG -e ARCH_SUPPORTS_LTO_CLANG_THIN -e HAS_LTO_CLANG -e LTO_NONE -d LTO_CLANG_FULL -d LTO_CLANG_THIN -d LTO_CLANG_THIN_DIST -e HAVE_GCC_PLUGINS
            ;;
        gcc)
            scripts/config -e LTO_NONE
            ;;
        *)
            _die "The _buildtype value '$_buildtype' is invalid. Choose the correct one again."
    esac

    if [ "$buildtype" = "lto" ]; then
        echo "Selecting 'clang' compiler, '$_buildtype' LLVM level..."
    else
        echo "Selecting '$_buildtype' compiler, no LTO..."
    fi

    ### Select tick rate
    case "$_HZ_ticks" in
        1000|800|750|600|500)
            scripts/config -d HZ_800 -d HZ_300 -e "HZ_${_HZ_ticks}" --set-val HZ "${_HZ_ticks}";;
        *)
            _die "The _HZ_ticks value '$_HZ_ticks' is invalid. Choose the correct one again."
    esac

    echo "Setting tick rate to ${_HZ_ticks} Hz..."

    ### Select tickless type
    case "$_ticktype" in
        full)
            scripts/config -d HZ_PERIODIC -d NO_HZ_IDLE -d CONTEXT_TRACKING_FORCE -e NO_HZ_FULL_NODEF -e NO_HZ_FULL -e NO_HZ -e NO_HZ_COMMON -e CONTEXT_TRACKING
            ;;
        idle)
            scripts/config -d HZ_PERIODIC -d NO_HZ_FULL -e NO_HZ_IDLE -e NO_HZ -e NO_HZ_COMMON
            scripts/config -d RCU_NOCB_CPU -d TICK_CPU_ACCOUNTING -e VIRT_CPU_ACCOUNTING_GEN
            ;;
        *)
            _die "The _ticktype value '$_ticktype' is invalid. Choose the correct one again."
    esac

    echo "Selecting '$_ticktype' tickless type..."

    ### Select preempt type
    case "$_preempt" in
        dynamic)
            scripts/config -d PREEMPT_NONE -d PREEMPT_VOLUNTARY -e PREEMPT -d PREEMPT_LAZY -e PREEMPT_DYNAMIC;;
        lazy)
            scripts/config -d PREEMPT_NONE -d PREEMPT_VOLUNTARY -d PREEMPT -e PREEMPT_LAZY -d PREEMPT_DYNAMIC;;
        full)
            scripts/config -d PREEMPT_NONE -d PREEMPT_VOLUNTARY -e PREEMPT -d PREEMPT_LAZY -d PREEMPT_DYNAMIC;;
        voluntary)
            scripts/config -d PREEMPT_NONE -e PREEMPT_VOLUNTARY -d PREEMPT -d PREEMPT_LAZY -d PREEMPT_DYNAMIC;;
        *)
            _die "The _preempt value '$_preempt' is invalid. Choose the correct one again."
    esac

    echo "Selecting '$_preempt' preempt type..."

    if [ "$_cpusched" = "rt" ]; then
        echo "Enabling real-time preemption, as well..."
        scripts/config -e PREEMPT_RT
        scripts/config -e DRM_MGAG200_DISABLE_WRITECOMBINE
    else
        scripts/config -d PREEMPT_RT
    fi

    if [ "$_buildtype" = "gcc" ]; then
        echo "Enabling KBUILD_CFLAGS -O2..."
        scripts/config -d CC_OPTIMIZE_FOR_PERFORMANCE_O3 -e CC_OPTIMIZE_FOR_PERFORMANCE
    else
        echo "Enabling KBUILD_CFLAGS -O3..."
        scripts/config -d CC_OPTIMIZE_FOR_PERFORMANCE -e CC_OPTIMIZE_FOR_PERFORMANCE_O3
    fi

    ### Enable bbr3
    if [[ "$_tcp_bbr3" =~ ^(yes|y|1)$ ]]; then
        echo "Disabling TCP_CONG_CUBIC..."
        scripts/config -m TCP_CONG_CUBIC \
            -d DEFAULT_CUBIC \
            -e TCP_CONG_BBR \
            -e DEFAULT_BBR \
            --set-str DEFAULT_TCP_CONG bbr \
            -m NET_SCH_FQ_CODEL \
            -e NET_SCH_FQ \
            -d CONFIG_DEFAULT_FQ_CODEL \
            -e CONFIG_DEFAULT_FQ
    fi

    ### Select THP
    case "$_hugepage" in
        always) scripts/config -d TRANSPARENT_HUGEPAGE_MADVISE -e TRANSPARENT_HUGEPAGE_ALWAYS;;
        madvise) scripts/config -d TRANSPARENT_HUGEPAGE_ALWAYS -e TRANSPARENT_HUGEPAGE_MADVISE;;
        *) _die "The _hugepage value '$_hugepage' is invalid. Choose the correct one again.";;
    esac

    echo "Selecting '$_hugepage' TRANSPARENT_HUGEPAGE config..."

    # Enable Clang AutoFDO
    if [[ "$_autofdo" =~ ^(yes|y|1)$ ]]; then
        scripts/config -e AUTOFDO_CLANG
    fi
    if [[ "$_autofdo" =~ ^(yes|y|1)$ && -n "$_autofdo_profile_name" ]]; then
        echo "The AutoFDO profile has been found..."
        BUILD_FLAGS+=(CLANG_AUTOFDO_PROFILE="${srcdir}/${_autofdo_profile_name}")
    fi

    echo "Enabling USER_NS_UNPRIVILEGED"
    scripts/config -e USER_NS

    ### Run the config.sh script for kernel tuning
    if [[ -s "${srcdir}"/config.sh ]]; then
        echo "Further kernel customization. Running config.sh script..."
        bash "${srcdir}"/config.sh
    fi

    ### Optionally run the trim.sh script to trim the kernel
    if [[ "$_runtrim_script" =~ ^(yes|y|1)$ && -s "${srcdir}"/trim.sh ]]; then
        echo "Further kernel trimming. Running trim.sh script..."
        bash "${srcdir}"/trim.sh
    fi

    ### Optionally run the custom.sh script for custom tuning
    if [ -n "$custom_script" ]; then
        echo "Custom kernel tuning. Running custom.sh script..."
        bash "$custom_script"
    fi

    ### Optionally load needed modules for the make localmodconfig
    ### https://aur.archlinux.org/packages/modprobed-db
    ### https://github.com/Frogging-Family/linux-tkg (minimal-modprobed.db)
    if [[ "$_localmodcfg" =~ ^(yes|y|1)$ ]]; then
        echo "Running Steven Rostedt's make localmodconfig now"
        [ -e "$_localmodcfg_path" ] || _die "No modprobed.db data found"

        [[ "$_localmodcfg_minimal" =~ ^(yes|y|1)$ ]] && \
           echo "Including the modules in minimal-modprobed.db"

        ( cat "$_localmodcfg_path"
           [[ "$_localmodcfg_minimal" =~ ^(yes|y|1)$ ]] && \
              cat "${srcdir}"/minimal-modprobed.db
           # Include RAM disk, exfat, ntsync, ttm, and modules for Docker
           # Include tcp_bbr, tcp_dctcp, and tcp_htcp for bpftune
           for module in \
              brd bridge exfat drm_ttm_helper llc irqbypass nf_conntrack \
              nf_conntrack_netlink nf_defrag_ipv4 nf_defrag_ipv6 nf_nat \
              nf_tables nft_chain_nat nft_compat ntsync overlay stp tcp_bbr \
              tcp_dctcp tcp_htcp ttm veth xfrm_algo xfrm_user xt_addrtype \
              xt_conntrack xt_MASQUERADE xt_nat xt_tcpudp \
           ;do echo "$module"; done
        ) | sort -u > "/tmp/modprobed.db.$$"

        make "${BUILD_FLAGS[@]}" LSMOD="/tmp/modprobed.db.$$" localmodconfig
        rm -f "/tmp/modprobed.db.$$"
    fi

    ### Rewrite configuration
    echo "Rewrite configuration..."
    make "${BUILD_FLAGS[@]}" -j3 prepare
    yes "" | make "${BUILD_FLAGS[@]}" config >/dev/null

    ### Prepared version
    make "${BUILD_FLAGS[@]}" -s kernelrelease > version
    echo "Prepared $pkgbase version $(<version)"

    ### Running make nconfig
    [[ "$_makenconfig" =~ ^(yes|y|1)$ ]] && make "${BUILD_FLAGS[@]}" nconfig

    ### Running make gconfig
    [[ "$_makegconfig" =~ ^(yes|y|1)$ ]] && make "${BUILD_FLAGS[@]}" gconfig

    ### Running make xconfig
    [[ "$_makexconfig" =~ ^(yes|y|1)$ ]] && make "${BUILD_FLAGS[@]}" xconfig

    ### Save configuration for later reuse
    echo "Save configuration for later reuse..."
    local basedir="$(dirname "$(readlink "${srcdir}/config")")"
    cat .config > "${basedir}/config-${pkgver}-${pkgrel}${pkgbase#linux}"
}

build() {
    cd "$_srcname"

    ### Respect -jN flag in /etc/makepkg.conf
    local ncpu=$(grep "^MAKEFLAGS=" "/etc/makepkg.conf" | sed "s/^.*-j\([0-9]*\).*/\1/")
    [[ -z "$ncpu" || "$ncpu" = "MAKEFLAGS"* ]] && ncpu=$(nproc)

    ### Use grep to filter/silence harmless warnings
    make "${BUILD_FLAGS[@]}" -j"$ncpu" all 2>&1 | \
       grep -Ev '^  (AS|AR|CC|LD|BT|CE|CO|GE|HO|IN|IP|MK|OB|PA|PE|PO|RE|ST|TA|TE|UN|UP|VD|WR|X32)|: unexpected end of section|: unreachable instruction| missing __noreturn in | no .sframe will be created'

    ### In the case compiling with a later LLVM release, use the
    ### system toolchain for auto-detecting system features
    env PATH="/usr/bin:$PATH" make -C tools/bpf/bpftool vmlinux.h feature-clang-bpf-co-re=1 | \
       grep -Ev '^  (AS|AR|CC|LD|BT|CE|CO|GE|HO|IN|IP|MK|OB|PA|PE|PO|RE|ST|TA|TE|UN|UP|VD|WR|X32)'
}

_package() {
    pkgdesc="The $pkgdesc kernel and modules"
    depends=('coreutils' 'kmod' 'initramfs')
    optdepends=('wireless-regdb: to set the correct wireless channels of your country'
                'linux-firmware: firmware images needed for some devices'
                'modprobed-db: Keeps track of EVERY kernel module that has ever been probed - useful for those of us who make localmodconfig'
                'scx-scheds: to use sched-ext schedulers')
    provides=(VIRTUALBOX-GUEST-MODULES WIREGUARD-MODULE KSMBD-MODULE V4L2LOOPBACK-MODULE NTSYNC-MODULE VHBA-MODULE ADIOS-MODULE)
    install="install"

    cd "$_srcname"

    local modulesdir="$pkgdir/usr/lib/modules/$(<version)"

    echo "Installing boot image..."
    # systemd expects to find the kernel here to allow hibernation
    # https://github.com/systemd/systemd/commit/edda44605f06a41fb86b7ab8128dcf99161d2344
    install -Dm644 "$(make "${BUILD_FLAGS[@]}" -s image_name)" "$modulesdir/vmlinuz"

    # Used by mkinitcpio to name the kernel
    echo "$pkgbase" | install -Dm644 /dev/stdin "$modulesdir/pkgbase"

    echo "Installing modules..."
    ZSTD_CLEVEL=6 make "${BUILD_FLAGS[@]}" INSTALL_MOD_PATH="$pkgdir/usr" INSTALL_MOD_STRIP=1 \
        DEPMOD=/doesnt/exist modules_install | grep -Ev '^  (IN|SI|ST|ZS)' # Suppress depmod

    # remove build links
    rm "$modulesdir"/build
}

_package-headers() {
    pkgdesc="Headers and scripts for building modules for the $pkgdesc kernel"
    depends=('pahole' "${pkgbase}")

    if [[ "$buildtype" =~ (lto|clang) ]]; then
        depends+=(clang llvm lld)
    fi

    cd "${_srcname}"
    local builddir="$pkgdir/usr/lib/modules/$(<version)/build"

    echo "Installing build files..."
    install -Dt "$builddir" -m644 .config Makefile Module.symvers System.map \
        localversion.* version vmlinux tools/bpf/bpftool/vmlinux.h
    install -Dt "$builddir/kernel" -m644 kernel/Makefile
    install -Dt "$builddir/arch/x86" -m644 arch/x86/Makefile
    cp -t "$builddir" -a scripts
    ln -srt "$builddir" "$builddir/scripts/gdb/vmlinux-gdb.py"

    # required when STACK_VALIDATION is enabled
    install -Dt "$builddir/tools/objtool" tools/objtool/objtool

    # required when DEBUG_INFO_BTF_MODULES is enabled
    if [ -f tools/bpf/resolve_btfids/resolve_btfids ]; then
        install -Dt "$builddir/tools/bpf/resolve_btfids" tools/bpf/resolve_btfids/resolve_btfids
    fi

    echo "Installing headers..."
    cp -t "$builddir" -a include
    cp -t "$builddir/arch/x86" -a arch/x86/include
    install -Dt "$builddir/arch/x86/kernel" -m644 arch/x86/kernel/asm-offsets.s

    install -Dt "$builddir/drivers/md" -m644 drivers/md/*.h
    install -Dt "$builddir/net/mac80211" -m644 net/mac80211/*.h

    # https://bugs.archlinux.org/task/13146
    install -Dt "$builddir/drivers/media/i2c" -m644 drivers/media/i2c/msp3400-driver.h

    # https://bugs.archlinux.org/task/20402
    install -Dt "$builddir/drivers/media/usb/dvb-usb" -m644 drivers/media/usb/dvb-usb/*.h
    install -Dt "$builddir/drivers/media/dvb-frontends" -m644 drivers/media/dvb-frontends/*.h
    install -Dt "$builddir/drivers/media/tuners" -m644 drivers/media/tuners/*.h

    # https://bugs.archlinux.org/task/71392
    install -Dt "$builddir/drivers/iio/common/hid-sensors" -m644 drivers/iio/common/hid-sensors/*.h

    echo "Installing KConfig files..."
    find . -name 'Kconfig*' -exec install -Dm644 {} "$builddir/{}" \;

    # Install .rmeta files if they exist
    if compgen -G "rust/*.rmeta" 1>/dev/null; then
        install -Dt "$builddir/rust" -m644 rust/*.rmeta
    fi

    # Install .so files if they exist
    if compgen -G "rust/*.so" 1>/dev/null; then
        install -Dt "$builddir/rust" rust/*.so
    fi

    echo "Installing unstripped VDSO..."
    make INSTALL_MOD_PATH="$pkgdir/usr" vdso_install \
        link=  # Suppress build-id symlinks

    echo "Removing unneeded architectures..."
    local arch
    for arch in "$builddir"/arch/*/; do
        [[ $arch = */x86/ ]] && continue
        echo "Removing $(basename "$arch")"
        rm -r "$arch"
    done

    echo "Removing documentation..."
    rm -r "$builddir/Documentation"

    echo "Removing broken symlinks..."
    find -L "$builddir" -type l -printf 'Removing %P\n' -delete

    echo "Removing loose objects..."
    find "$builddir" -type f -name '*.o' -printf 'Removing %P\n' -delete

    echo "Stripping build tools..."
    local file
    while read -rd '' file; do
        case "$(file -Sib "$file")" in
            application/x-sharedlib\;*)      # Libraries (.so)
                strip -v $STRIP_SHARED "$file" ;;
            application/x-archive\;*)        # Libraries (.a)
                strip -v $STRIP_STATIC "$file" ;;
            application/x-executable\;*)     # Binaries
                strip -v $STRIP_BINARIES "$file" ;;
            application/x-pie-executable\;*) # Relocatable binaries
                strip -v $STRIP_SHARED "$file" ;;
        esac
    done < <(find "$builddir" -type f -perm -u+x ! -name vmlinux -print0)

    echo "Stripping vmlinux..."
    strip -v $STRIP_STATIC "$builddir/vmlinux"

    echo "Adding symlink..."
    mkdir -p "$pkgdir/usr/src"
    ln -sr "$builddir" "$pkgdir/usr/src/$pkgbase"
}

_package-dbg(){
    pkgdesc="Non-stripped vmlinux file for the $pkgdesc kernel"
    depends=("${pkgbase}-headers")

    cd "${_srcname}"
    mkdir -p "$pkgdir/usr/src/debug/${pkgbase}"
    install -Dt "$pkgdir/usr/src/debug/${pkgbase}" -m644 vmlinux
}

pkgname=("$pkgbase")
[[ "$_build_debug" =~ ^(yes|y|1)$ ]] && pkgname+=("$pkgbase-dbg")
pkgname+=("$pkgbase-headers")
for _p in "${pkgname[@]}"; do
    eval "package_$_p() {
    $(declare -f "_package${_p#$pkgbase}")
    _package${_p#$pkgbase}
    }"
done

b2sums=('7338c33e209a87d2acdc80cb30066b719a1924ac38db0ac4087c4cb2ae6d510d75fbc97eeadac9bbc070afe09f29e65fd7ab18383fe677adcf993c17d4407535'
        '64b36aa11f05bd5688ff8b365b248860b289eeec5db617f4d13eff4b37d25a57a70fbbb6f7804ba0c26fcfe8427a7779d3d40c6c21254e4e4b8745e99f139e2f'
        '6f663ce6533d4ba0237616fee68a1bfe56cd3cda520b526f92d817e546008b144de7ae6b399605dc3a33b7a4be97fd16fe0d707cd7c016ff45444f87c1d5c1b5'
        'd0b5a7a0bf638c93cc763c45164a38a55223c6349f92997e0136717fca41fb57891b73d8e599381940cd6d783a2a75088b3204b4d8fb86e2a108101b21625224'
        'fb920f9c99f41240248452e772ff539fa5c0a77f60128d2e2bf2666f4ff460b711fe9513c0840bf914122f76c9afc14a01237231abbd3238b5bec9b628cbab95'
        'e5c22aff12f20d4cd35e29e80812a8030223a752d10b94f88f9be6477cd0e82b386625bc6ea857a632003083448a6080c4201b9a0b5de05b4090e16a60cbea8a'
        '204eb784a702af2a24eaf6f284b1fdf68a40d78cdde64a64a081ea5e19d61e256ad8e0645f53263d6a6ec33a42eb966a0e8d76d846e89c79be488b5f714ebf61'
        '4a446b68046913bcf30ce4364ad56c2ff99573f3eb75803ab7eaf7885008f09d0a7289131c8f947c81f4c39e8a28f4c5b9628519386e9cfc8070c65360b6b878'
        '918dfd7cb0638fb571fcb7594623947848b7ac2a7f374b6174340a9d8be9ecf6198f41247a8930afb37a69021f62228f607fccc323956fca7a12db7620be2966'
        '813e39fb4248f0935bd532aecd9b023f7fa1701ae3d951b7a30cc2a85f26f25c11814dff44906c52d48b77853e6ee9f2fb79fd6b59f805e994201c0c428f590e'
        '2853e6975cb9ea481918a85d63945cb50b421d7bb60dc1d511a42fe0a3bc06244bd16293f2674504f1ba6e6f3a15f3f19fcfac2a0ea06df9775d5f3f0afec171'
        'e6080c95601e17bff9bb8d4bc3f55f80211391e86d7b278cbfef2f44261614141e7688805592ef50b5b9aa671f592d7c83684b2aeead8590c7681cfc219582d7'
        'ae3343284cf5b60380905136f08dbeee30cbbd9e323ea64e07450b5af6df98eac41de48af3c476ba350b909af9eed23328296943b02fda30121a138c7be5ae1e'
        'd4a951537391e91998185b3732bae5333416477b3abaedd2121926295afdc201815525adc41382c90246212837a6e5886baf5c725d1e79479a841cc7a7b3c150'
        '5f5d80c18679b37bf2d893414a76f6a52de81725c069ee2c9824ca48652911d5eb1febd4c220282b436dcb1a525281ffe0bac98a32a5080dec592743c0c12bd1'
        '089f0671fc33b0209dc55b39bcddde0c0a6634f0144253018f9d48ce6433b7f067c51984c1a74a46e0fdaf7b4722a0878e6c80856b4518a6830fae369036e074'
        '46a0be391abb095b52abe73236cca35cdeed8641589922bf94b3de66e5ae8fddeab639b2d6cfe1ff7dc78cc986a374ebace98a6b8998fada1a482963535a4301'
        '36b41b06f930926efee55d9160ff73579d1147f997f89e24438bba1a6687b16a1b7a64920de67ff8993e162e904348345e23a19c4ad3b6431c512d7a00dcae48'
        '16c46121165982898ebf0c695704f499f5ea38f1eb3eaaee50b3b8c36d356a8b243cdce598c8d962567a2ab042231f3ba52e1d3b2ac7ad3afbfbf3e3291dbbdc'
        'ee6a614c89e45d68ebca42c2b8d34ffa3fa7134e0f7aa1a4d1c19e21228852b6506ae7c8eee1484b603a5f8eac5d4851f7796e82c8c5fa166c556cae81b1e04b'
        '33c70b59e828825904e520e1bee345dd707200c5a5bd79260a6a5d90b4ec52846c91547129cab7fef10e49b424a82910da98c2dec355d3a2a93ef13f322741fd'
        'ac5c49e67651d575e450ede2af8d0bf93d3d5b7ab79f33e5d75d4abf90785dd9f0490926b8b6ad36983fd6ade69def3f28cd349f8ea270ffb6c3abf8a261f1dc'
        '1cdac88541ddf5c0571412a19e1770178ee52867d0f6beb6d00d51edfa13edee5f2840583faf945d6c8c387477f99ac1b40153fcd62e02f6fb7af772992f8737'
        '6d6f6cb15fec1ea23ec3cfcffd81e96224d8c261e62c6f51c0146d7e270b8d31fa1905ea9fa92874d3565a0aa5f02cf2b1863102a6285b6276de5336f1c582c8')
